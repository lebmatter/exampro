{% extends "exampro/templates/exam_base.html" %}

{% block title %}
{{ title or _("Exam Leaderboard") }}
{% endblock %}

{% block head_include %}
{{ super() }}
<link rel="stylesheet" href="/assets/exampro/css/leaderboard.css" />
{% endblock %}

{% block page_content %}
<div class="confetti-bg" id="confetti-bg"></div>
<div class="container">
    <div>
            {% if show_error %}
                <!-- Error Section -->
                <div class="row mb-5">
                    <div class="col">
                        <h4 class="bold-heading"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i> {{ title }}</h4>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <i class="bi bi-lock-fill me-2"></i> {{ _("Access Restricted") }}
                            </div>
                            <div class="card-body text-center p-4">
                                <p class="mb-0">{{ error_message }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- Header Section -->
                <div class="row mb-5">
                    <div class="col">
                        <h4 class="bold-heading"><i class="bi bi-trophy-fill text-warning me-2"></i> {{ _("Exam Leaderboard") }}</h4>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <h5 class="exam-title">{{ exam.title }}</h5>
                        <div class="exam-info">
                            {% if exam.description %}{{ exam.description }}<br>{% endif %}
                            <!-- <span class="badge bg-info">{{ exam.leaderboard_type }}</span>
                            <span class="badge bg-secondary">Total: {{ exam.total_marks }}</span>
                            <span class="badge bg-success">Pass: {{ exam.pass_percentage }}%</span> -->
                        </div>
                    </div>
                </div>

                <!-- User Stats Card -->
                {% if user_submission %}
                <div class="row mb-4">
                    <div class="col">
                        <div class="card border-light">
                            <div class="card-header bg-light">
                                <i class="bi bi-person-fill me-2"></i> {{ _("Your Performance") }}
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="h4">{{ user_submission.total_marks }}/{{ exam.total_marks }}</div>
                                        <small>{{ _("Your Score") }}</small>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="h4">{{ "%.1f"|format(user_submission.percentage) }}%</div>
                                        <small>{{ _("Percentage") }}</small>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="h4">
                                            <span class="badge {% if user_submission.result_status == 'Passed' %}bg-success{% else %}bg-danger{% endif %} text-white">
                                                {{ user_submission.result_status }}
                                            </span>
                                        </div>
                                        <small>{{ _("Result") }}</small>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="h4">
                                            {% if user_rank %}
                                                #{{ user_rank }}
                                            {% else %}
                                                {{ _("Not Ranked") }}
                                            {% endif %}
                                        </div>
                                        <small>{{ _("Your Rank") }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Stats Cards -->
                {% if stats %}
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card border-light h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-people-fill text-primary mb-2" style="font-size: 1.5rem;"></i>
                                <h5 class="card-title">{{ stats.total_participants }}</h5>
                                <p class="card-text text-muted">{{ _("Total Participants") }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-light h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-graph-up text-success mb-2" style="font-size: 1.5rem;"></i>
                                <h5 class="card-title">{{ "%.1f"|format(stats.average_score) }}%</h5>
                                <p class="card-text text-muted">{{ _("Average Score") }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-light h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-award-fill text-warning mb-2" style="font-size: 1.5rem;"></i>
                                <h5 class="card-title">{{ "%.1f"|format(stats.highest_score) }}%</h5>
                                <p class="card-text text-muted">{{ _("Highest Score") }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-light h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-check-circle-fill text-info mb-2" style="font-size: 1.5rem;"></i>
                                <h5 class="card-title">{{ "%.1f"|format(stats.pass_rate) }}%</h5>
                                <p class="card-text text-muted">{{ _("Pass Rate") }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Leaderboard Table -->
                <div class="card border-light mb-5">
                    <div class="card-header bg-light">
                        <i class="bi bi-trophy-fill me-2"></i> {{ _("Leaderboard Rankings") }}
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            {% if leaderboard_data and leaderboard_data|length > 0 %}
                                <table class="table table-hover mb-0">
                                    <thead class="thead-light">
                                        <tr>
                                            <th width="80">{{ _("Rank") }}</th>
                                            <th>{{ _("Candidate") }}</th>
                                            <th width="120">{{ _("Score") }}</th>
                                            <th width="120">{{ _("Percentage") }}</th>
                                            <th width="150">{{ _("Time") }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                {% for submission in leaderboard_data %}
                                <tr {% if submission.candidate == frappe.session.user %}class="user-rank-highlight"{% endif %}>
                                    <td class="rank-cell">
                                        {% if loop.index <= 3 %}
                                            <span class="rank-{{ loop.index }}">{{ loop.index }}</span>
                                        {% else %}
                                            <span style="font-weight: 600;">{{ loop.index }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="candidate-info">
                                            <div class="candidate-avatar">
                                                {% set initials = submission.candidate_name.split(' ')|map('first')|join('')|upper %}
                                                {{ initials }}
                                            </div>
                                            <span class="candidate-name rank-{{ loop.index }}-name">
                                                {{ submission.candidate_name }}
                                                {% if submission.candidate == frappe.session.user %}
                                                    <i class="bi bi-star-fill text-warning ms-1" title="You"></i>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="score-cell 
                                        {% if submission.percentage >= 90 %}score-excellent
                                        {% elif submission.percentage >= 75 %}score-good
                                        {% elif submission.percentage >= 60 %}score-average
                                        {% else %}score-poor{% endif %}">
                                        {{ submission.total_marks }}/{{ submission.max_marks }}
                                    </td>
                                    <td class="text-center">
                                        <span class="percentage-badge 
                                            {% if submission.percentage >= 90 %}percentage-excellent
                                            {% elif submission.percentage >= 75 %}percentage-good
                                            {% elif submission.percentage >= 60 %}percentage-average
                                            {% else %}percentage-poor{% endif %}">
                                            {{ "%.1f"|format(submission.percentage) }}%
                                        </span>
                                    </td>
                                    <td class="text-center text-muted">
                                        {{ submission.completion_time or "N/A" }}
                                    </td>
                                </tr>
                                {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <div class="text-center p-5">
                                    <i class="bi bi-bar-chart-fill mb-3" style="font-size: 2.5rem; color: #dee2e6;"></i>
                                    <h5>{{ _("No Leaderboard Data") }}</h5>
                                    <p class="text-muted">{{ _("No valid submissions found for this exam leaderboard") }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block script %}
{{ super() }}
<script type="text/javascript" src="/assets/exampro/js/leaderboard.js"></script>
{% endblock %}