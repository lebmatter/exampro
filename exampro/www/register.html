{% extends "exampro/templates/exam_base.html" %} {% block title %}Register for
{{ exam.title if exam else 'Exam' }}{% endblock %} {% block head_include %} {{
super() }}
<link rel="stylesheet" href="/assets/exampro/css/exam-result.css" />
<style>
  .registration-card {
    max-width: 800px;
    margin: 2rem auto;
  }

  .exam-info {
    background: #f8f9fa;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-radius: 0.5rem;
  }

  .schedule-card {
    border: 1px solid #dee2e6;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .schedule-card:hover {
    border-color: #0d6efd;
    background-color: #f8f9fa;
  }

  .schedule-card.selected {
    border-color: #0d6efd;
    background-color: #e7f1ff;
  }

  .schedule-card input[type="radio"] {
    transform: scale(1.2);
    margin-right: 0.75rem;
  }

  .schedule-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .schedule-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    margin-left: 0.5rem;
  }

  .badge-upcoming {
    background-color: #cfe2ff;
    color: #084298;
  }

  .badge-ongoing {
    background-color: #d1e7dd;
    color: #0f5132;
  }

  .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
  }

  .error-card {
    max-width: 600px;
    margin: 2rem auto;
    text-align: center;
  }

  .error-icon {
    font-size: 4rem;
    color: #dc3545;
  }

  .form-control[readonly] {
    background-color: #e9ecef;
    cursor: not-allowed;
    opacity: 1;
  }
</style>
{% endblock %} {% block page_content %}
<div class="container mt-4 mb-4">
  {% if show_error %}
  <div class="card error-card">
    <div class="card-body">
      <div class="error-icon">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
      <h3 class="mt-3">Error</h3>
      <p class="text-muted">{{ error_message }}</p>
      <a href="/" class="btn btn-primary mt-3">
        <i class="bi bi-house-door mr-2"></i>Go to Home
      </a>
    </div>
  </div>
  {% else %}
  <div class="card registration-card">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-clipboard-check"></i> Register for Exam
      </h5>
    </div>

    <div class="card-body">
      <!-- Exam Information -->
      <div class="exam-info">
        <h4>{{ exam.title }}</h4>
        {% if exam.description %}
        <div class="mt-2">{{ exam.description|safe }}</div>
        {% endif %}
        <div class="mt-3">
          <div class="row">
            <div class="col-md-6">
              <strong><i class="bi bi-bar-chart"></i> Pass Percentage:</strong>
              <span>{{ exam.pass_percentage }}%</span>
            </div>
          </div>
        </div>
      </div>

      {% if not has_schedules %}
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        No available exam schedules at this time. Please check back later.
      </div>
      {% else %}

      <!-- Registration Form -->
      <form id="registrationForm">
        <!-- Schedule Selection -->
        <div class="mb-4">
          <label class="form-label">
            <i class="bi bi-calendar-check"></i> Select Exam Schedule *
          </label>
          <div id="scheduleList">
            {% for schedule in schedules %}
            <label class="schedule-card" for="schedule-{{ loop.index }}">
              <div class="d-flex align-items-start">
                <input
                  type="radio"
                  name="schedule"
                  id="schedule-{{ loop.index }}"
                  value="{{ schedule.name }}"
                  required
                />
                <div class="schedule-info flex-grow-1">
                  <div>
                    <strong>{{ schedule.name }}</strong>
                    <span
                      class="schedule-badge badge-{{ schedule.status.lower() }}"
                    >
                      {{ schedule.status }}
                    </span>
                  </div>
                  <div class="text-muted">
                    <i class="bi bi-calendar3"></i>
                    {% if schedule.schedule_type == 'Fixed' %} {{
                    schedule.start_date_time.strftime('%d %b %Y, %I:%M %p') }}
                    {% else %} Available from: {{
                    schedule.start_date_time.strftime('%d %b %Y, %I:%M %p') }}
                    ({{ schedule.schedule_expire_in_days }} days) {% endif %}
                  </div>
                  <div class="text-muted">
                    <i class="bi bi-clock"></i> Duration: {{ schedule.duration
                    }} minutes
                  </div>
                </div>
              </div>
            </label>
            {% endfor %}
          </div>
        </div>

        {% if is_logged_in %}
        <!-- Personal Information -->
        <div class="row mb-3">
          <div class="col-md-12">
            <label for="candidateName" class="form-label">
              <i class="bi bi-person"></i> Your Name *
            </label>
            <small class="text-muted d-block mb-2">Name will be appeared in your certificates, if applicable.</small>
            <input
              type="text"
              class="form-control"
              id="candidateName"
              placeholder="Enter your full name"
              value="{{ user_full_name }}"
              required
            />
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="candidateEmail" class="form-label">
              <i class="bi bi-envelope"></i> Your Email * <small class="text-muted">(cannot be changed)</small>
            </label>
            <input
              type="email"
              class="form-control"
              id="candidateEmail"
              placeholder="your.email@example.com"
              value="{{ user_email }}"
              readonly
              required
            />
          </div>

          <div class="col-md-6">
            <label for="candidatePhone" class="form-label">
              <i class="bi bi-telephone"></i> Your Phone Number
            </label>
            <input
              type="tel"
              class="form-control"
              id="candidatePhone"
              placeholder="+1234567890"
              value="{{ user_phone }}"
            />
          </div>
        </div>

        <!-- Submit Button -->
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-primary" id="registerBtn">
            <i class="bi bi-check-circle"></i> Register for Exam
          </button>
        </div>

        <!-- Message Display -->
        <div id="messageContainer" class="mt-3" style="display: none"></div>
        {% else %}
        <!-- Login Prompt for Non-logged-in Users -->
        <div class="alert alert-info mt-4">
          <div class="d-flex align-items-center">
            <i class="bi bi-info-circle" style="font-size: 1.5rem; margin-right: 1rem;"></i>
            <div>
              <strong>Login Required</strong>
              <p class="mb-2">Please log in to complete your registration for this exam.</p>
              <a href="/login?redirect-to={{ current_page_url | urlencode }}" class="btn btn-primary btn-sm">
                <i class="bi bi-box-arrow-in-right"></i> Login to Register
              </a>
            </div>
          </div>
        </div>
        {% endif %}
      </form>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %} {% block script %} {{ super() }}
<script>
  $(document).ready(function () {
    var isLoggedIn = {{ "true" if is_logged_in else "false" }};

    // Ensure email field is readonly for logged-in users
    if (isLoggedIn) {
      $("#candidateEmail").prop("readonly", true);
    }

    // Handle schedule card click
    $(".schedule-card").click(function () {
      $(".schedule-card").removeClass("selected");
      $(this).addClass("selected");
      $(this).find('input[type="radio"]').prop("checked", true);
    });

    // Handle form submission
    $("#registrationForm").submit(function (e) {
      e.preventDefault();

      // If not logged in, prevent submission
      if (!isLoggedIn) {
        return;
      }

      const selectedSchedule = $('input[name="schedule"]:checked').val();
      const name = $("#candidateName").val().trim();
      const email = $("#candidateEmail").val().trim();
      const phone = $("#candidatePhone").val().trim();

      if (!selectedSchedule || !name) {
        showMessage("Please fill in all required fields.", "danger");
        return;
      }

      // Disable submit button
      $("#registerBtn")
        .prop("disabled", true)
        .html(
          '<span class="spinner-border spinner-border-sm mr-2"></span>Registering...'
        );

      // Make API call
      frappe.call({
        method: "exampro.www.register.index.register_for_exam",
        args: {
          schedule_name: selectedSchedule,
          name: name,
          email: email,
          phone: phone,
        },
        callback: function (r) {
          $("#registerBtn")
            .prop("disabled", false)
            .html('<i class="bi bi-check-circle"></i> Register for Exam');

          if (r.message && r.message.success) {
            showMessage(r.message.message, "success");
            // Clear form
            $("#registrationForm")[0].reset();
            $(".schedule-card").removeClass("selected");

            // Redirect to login or exam page after 2 seconds
            setTimeout(function () {
              window.location.href = "/my-exams";
            }, 2000);
          } else {
            showMessage(
              r.message
                ? r.message.message
                : "Registration failed. Please try again.",
              "danger"
            );
          }
        },
        error: function (err) {
          $("#registerBtn")
            .prop("disabled", false)
            .html('<i class="bi bi-check-circle"></i> Register for Exam');
          showMessage("An error occurred. Please try again.", "danger");
        },
      });
    });

    function showMessage(message, type) {
      const alertClass = type === "success" ? "alert-success" : "alert-danger";
      const icon =
        type === "success" ? "bi-check-circle" : "bi-exclamation-triangle";

      $("#messageContainer")
        .html(
          `
          <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="bi ${icon}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `
        )
        .show();

      // Auto-hide success messages after 3 seconds
      if (type === "success") {
        setTimeout(function () {
          $("#messageContainer").fadeOut();
        }, 3000);
      }
    }
  });
</script>
{% endblock %}
