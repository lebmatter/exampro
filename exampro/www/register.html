{% extends "exampro/templates/exam_base.html" %}

{% block title %}Register for {{ exam.title if exam else 'Exam' }}{% endblock %}

{% block head_include %}
{{ super() }}
<link rel="stylesheet" href="/assets/exampro/css/exam-result.css" />
<style>
  .registration-card {
    max-width: 800px;
    margin: 2rem auto;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
  }

  .exam-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 0.5rem 0.5rem 0 0;
  }

  .exam-info {
    background: #f8f9fa;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-radius: 0.5rem;
  }

  .schedule-card {
    border: 2px solid #e9ecef;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s;
  }

  .schedule-card:hover {
    border-color: #667eea;
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
  }

  .schedule-card.selected {
    border-color: #667eea;
    background-color: #f0f3ff;
  }

  .schedule-card input[type="radio"] {
    transform: scale(1.3);
    margin-right: 0.75rem;
  }

  .schedule-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .schedule-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .badge-upcoming {
    background-color: #d1ecf1;
    color: #0c5460;
  }

  .badge-ongoing {
    background-color: #d4edda;
    color: #155724;
  }

  .form-label {
    font-weight: 600;
    color: #495057;
  }

  .btn-register {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .btn-register:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  .error-card {
    max-width: 600px;
    margin: 2rem auto;
    text-align: center;
  }

  .error-icon {
    font-size: 4rem;
    color: #dc3545;
  }
</style>
{% endblock %}

{% block page_content %}
<div class="container mt-4 mb-4">
  {% if show_error %}
  <div class="card error-card">
    <div class="card-body">
      <div class="error-icon">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
      <h3 class="mt-3">Error</h3>
      <p class="text-muted">{{ error_message }}</p>
      <a href="/" class="btn btn-primary mt-3">
        <i class="bi bi-house-door mr-2"></i>Go to Home
      </a>
    </div>
  </div>
  {% else %}
  <div class="card registration-card">
    <div class="exam-header">
      <h2 class="mb-0">
        <i class="bi bi-clipboard-check"></i> Register for Exam
      </h2>
    </div>

    <div class="card-body">
      <!-- Exam Information -->
      <div class="exam-info">
        <h4>{{ exam.title }}</h4>
        {% if exam.description %}
        <div class="mt-2">{{ exam.description|safe }}</div>
        {% endif %}
        <div class="mt-3">
          <div class="row">
            <div class="col-md-4">
              <strong><i class="bi bi-clock"></i> Duration:</strong>
              <span>{{ exam.duration }} minutes</span>
            </div>
            <div class="col-md-4">
              <strong><i class="bi bi-bar-chart"></i> Pass Percentage:</strong>
              <span>{{ exam.pass_percentage }}%</span>
            </div>
            <div class="col-md-4">
              <strong><i class="bi bi-file-earmark-text"></i> Questions:</strong>
              <span>{{ exam.total_questions }}</span>
            </div>
          </div>
        </div>
      </div>

      {% if not has_schedules %}
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        No available exam schedules at this time. Please check back later.
      </div>
      {% else %}

      <!-- Registration Form -->
      <form id="registrationForm">
        <!-- Schedule Selection -->
        <div class="mb-4">
          <label class="form-label">
            <i class="bi bi-calendar-check"></i> Select Exam Schedule *
          </label>
          <div id="scheduleList">
            {% for schedule in schedules %}
            <label class="schedule-card" for="schedule-{{ loop.index }}">
              <div class="d-flex align-items-start">
                <input
                  type="radio"
                  name="schedule"
                  id="schedule-{{ loop.index }}"
                  value="{{ schedule.name }}"
                  required
                />
                <div class="schedule-info flex-grow-1">
                  <div>
                    <strong>{{ schedule.name }}</strong>
                    <span class="schedule-badge badge-{{ schedule.status.lower() }}">
                      {{ schedule.status }}
                    </span>
                  </div>
                  <div class="text-muted">
                    <i class="bi bi-calendar3"></i>
                    {% if schedule.schedule_type == 'Fixed' %}
                    {{ schedule.start_date_time.strftime('%d %b %Y, %I:%M %p') }}
                    {% else %}
                    Available from: {{ schedule.start_date_time.strftime('%d %b %Y, %I:%M %p') }}
                    ({{ schedule.schedule_expire_in_days }} days)
                    {% endif %}
                  </div>
                  <div class="text-muted">
                    <i class="bi bi-clock"></i> Duration: {{ schedule.duration }} minutes
                  </div>
                </div>
              </div>
            </label>
            {% endfor %}
          </div>
        </div>

        <!-- Personal Information -->
        <div class="row mb-3">
          <div class="col-md-12">
            <label for="candidateName" class="form-label">
              <i class="bi bi-person"></i> Your Name *
            </label>
            <input
              type="text"
              class="form-control"
              id="candidateName"
              placeholder="Enter your full name"
              required
            />
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="candidateEmail" class="form-label">
              <i class="bi bi-envelope"></i> Your Email *
            </label>
            <input
              type="email"
              class="form-control"
              id="candidateEmail"
              placeholder="your.email@example.com"
              required
            />
          </div>

          <div class="col-md-6">
            <label for="candidatePhone" class="form-label">
              <i class="bi bi-telephone"></i> Your Phone Number
            </label>
            <input
              type="tel"
              class="form-control"
              id="candidatePhone"
              placeholder="+1234567890"
            />
          </div>
        </div>

        <!-- Submit Button -->
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-primary btn-register" id="registerBtn">
            <i class="bi bi-check-circle"></i> Register for Exam
          </button>
        </div>

        <!-- Message Display -->
        <div id="messageContainer" class="mt-3" style="display: none;"></div>
      </form>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script>
  $(document).ready(function () {
    // Handle schedule card click
    $('.schedule-card').click(function () {
      $('.schedule-card').removeClass('selected');
      $(this).addClass('selected');
      $(this).find('input[type="radio"]').prop('checked', true);
    });

    // Handle form submission
    $('#registrationForm').submit(function (e) {
      e.preventDefault();

      const selectedSchedule = $('input[name="schedule"]:checked').val();
      const name = $('#candidateName').val().trim();
      const email = $('#candidateEmail').val().trim();
      const phone = $('#candidatePhone').val().trim();

      if (!selectedSchedule || !name || !email) {
        showMessage('Please fill in all required fields.', 'danger');
        return;
      }

      // Disable submit button
      $('#registerBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm mr-2"></span>Registering...');

      // Make API call
      frappe.call({
        method: 'exampro.www.register.index.register_for_exam',
        args: {
          schedule_name: selectedSchedule,
          name: name,
          email: email,
          phone: phone
        },
        callback: function (r) {
          $('#registerBtn').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Register for Exam');

          if (r.message && r.message.success) {
            showMessage(r.message.message, 'success');
            // Clear form
            $('#registrationForm')[0].reset();
            $('.schedule-card').removeClass('selected');

            // Redirect to login or exam page after 2 seconds
            setTimeout(function () {
              window.location.href = '/my-exams';
            }, 2000);
          } else {
            showMessage(r.message ? r.message.message : 'Registration failed. Please try again.', 'danger');
          }
        },
        error: function (err) {
          $('#registerBtn').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Register for Exam');
          showMessage('An error occurred. Please try again.', 'danger');
        }
      });
    });

    function showMessage(message, type) {
      const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
      const icon = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle';

      $('#messageContainer')
        .html(`
          <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="bi ${icon}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `)
        .show();

      // Auto-hide success messages after 3 seconds
      if (type === 'success') {
        setTimeout(function () {
          $('#messageContainer').fadeOut();
        }, 3000);
      }
    }
  });
</script>
{% endblock %}
